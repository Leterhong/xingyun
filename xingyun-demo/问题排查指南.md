# 问题排查指南

## 🐛 当前问题

1. **对话历史框一直显示"思考中..."**
2. **数字人没有读出所有AI生成的内容**

---

## 🔍 问题原因分析

### 问题1：一直显示"思考中"

**原因**：
- `isLoading` 状态没有被正确重置为 `false`
- `emit('message', 'assistant', content)` 没有被触发
- 流式响应可能出错或卡住

### 问题2：内容没有全部读出

**原因**：
- 流式响应可能没有正确接收完整
- `done` 标记可能没有触发
- speak 调用可能有问题

---

## ✅ 已添加的修复

### 1. 增强错误处理

```typescript
catch (error: any) {
  console.error('LLM调用错误:', error)
  ElMessage.error(`对话失败: ${error.message}`)
  xingyunService.interactiveidle()
  // ✅ 通知父组件错误，重置加载状态
  emit('message', 'assistant', '抱歉，我遇到了一些问题，请重试。')
}
```

### 2. 添加详细日志

现在会在控制台输出：
- ✅ 每个接收到的 chunk
- ✅ buffer 和 fullResponse 的长度
- ✅ 每次 speak 调用的内容
- ✅ 最终发送的总字数

---

## 🔧 排查步骤

### 步骤1：打开浏览器控制台

按 `F12` 打开开发者工具，切换到 **Console** 标签。

### 步骤2：清空控制台

点击清空按钮（🚫图标）或按 `Ctrl + L`。

### 步骤3：发送测试消息

在聊天框输入：
```
你好，请介绍一下自己
```

### 步骤4：观察控制台输出

#### 正常情况应该看到：

```javascript
✅ 开始接收流式响应...
✅ Chunk 1: 你好
✅ Chunk 2: ，我是
✅ Chunk 3: 洪
...
✅ 流式接收: { chunk: "你好", bufferLength: 2, fullLength: 2, done: false }
✅ 流式接收: { chunk: "，我是", bufferLength: 5, fullLength: 7, done: false }
...
✅ 首次发送: 你好，我是洪，很高兴认识...
✅ 后续发送: 你，我可以帮助...
✅ 流式结束，处理剩余内容: { fullResponse: "...", fullLength: 50, sentLength: 40, buffer: "..." }
✅ 发送剩余内容: 您的吗？
✅ ✅ 播报完成，总字数: 50, 已发送: 50
✅ 流式响应结束，总接收: 50 字，共 25 个chunk
```

#### 异常情况可能看到：

```javascript
❌ API错误响应: ...
❌ HTTP错误 401: Unauthorized
❌ 解析JSON失败: ...
❌ 无法获取响应流
❌ LLM调用错误: ...
```

---

## 🎯 根据日志判断问题

### 情况1：没有任何日志

**问题**：请求没有发出

**检查**：
1. 数字人是否已连接？
2. API Key 是否配置正确？
3. 网络是否正常？

**解决方法**：
```javascript
// 在控制台检查配置
console.log('AppID:', localStorage.getItem('xingyun_appId'))
console.log('API Key:', localStorage.getItem('llm_apiKey')?.substring(0, 10) + '...')
```

---

### 情况2：有"开始接收"，但没有 chunk

**问题**：API 没有返回数据

**可能原因**：
1. API Key 无效
2. 账户余额不足
3. 模型名称错误
4. baseURL 不正确

**解决方法**：
```javascript
// 检查配置
console.log('模型:', localStorage.getItem('llm_model'))

// 手动测试 API
fetch('https://api.deepseek.com/chat/completions', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ' + localStorage.getItem('llm_apiKey'),
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    model: 'deepseek-chat',
    messages: [{role: 'user', content: '你好'}],
    stream: false
  })
}).then(r => r.json()).then(console.log)
```

---

### 情况3：有 chunk，但没有"播报完成"

**问题**：流式响应没有结束

**可能原因**：
1. done 标记没有收到
2. 流被中断
3. 网络不稳定

**解决方法**：
查看最后一条日志，是否收到 `[DONE]` 标记

---

### 情况4：有"播报完成"，但历史框还是"思考中"

**问题**：`emit('message')` 没有触发或父组件没有响应

**检查**：
```javascript
// 在控制台检查
const app = document.querySelector('#app').__vue_app__
console.log('是否有 isLoading:', app._context.provides)
```

**解决方法**：
手动重置状态，在控制台执行：
```javascript
// 刷新页面
location.reload()
```

---

### 情况5：有"播报完成"，但数字人没读完

**问题**：speak 调用有问题或 SDK 异常

**检查**：
查看日志中的 `sentLength` 是否等于 `fullResponse.length`

**如果不等于**：
```javascript
⚠️ 检测到未发送的内容，立即补发: xxxx
```
说明已自动补发

**如果等于但还是没读完**：
可能是 SDK 的问题，检查：
1. 数字人是否在线？
2. 状态指示器是否显示"已连接"？
3. 网络延迟是否过高？

---

## 🛠️ 常见问题解决方案

### 解决方案1：重置状态

如果一直"思考中"，在控制台执行：

```javascript
// 方法1：刷新页面
location.reload()

// 方法2：清空localStorage重新配置
localStorage.clear()
location.reload()
```

---

### 解决方案2：检查API配置

```javascript
// 检查所有配置
const config = {
  appId: localStorage.getItem('xingyun_appId'),
  appSecret: localStorage.getItem('xingyun_appSecret'),
  llmModel: localStorage.getItem('llm_model'),
  llmApiKey: localStorage.getItem('llm_apiKey'),
}

console.table(config)

// 检查哪个配置缺失
Object.entries(config).forEach(([key, value]) => {
  if (!value) console.error(`❌ ${key} 未配置`)
  else console.log(`✅ ${key} 已配置`)
})
```

---

### 解决方案3：手动测试 API

```javascript
// 测试 DeepSeek API
async function testAPI() {
  const apiKey = localStorage.getItem('llm_apiKey')
  
  try {
    const response = await fetch('https://api.deepseek.com/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'deepseek-chat',
        messages: [{role: 'user', content: '你好'}],
        stream: false
      })
    })
    
    if (response.ok) {
      const data = await response.json()
      console.log('✅ API 正常:', data)
    } else {
      const error = await response.text()
      console.error('❌ API 错误:', error)
    }
  } catch (e) {
    console.error('❌ 请求失败:', e)
  }
}

testAPI()
```

---

### 解决方案4：监控 speak 调用

```javascript
// 监控所有 speak 调用
window.speakCalls = []

// 需要在页面加载后执行
setTimeout(() => {
  const originalConsoleLog = console.log
  console.log = function(...args) {
    if (args[0]?.includes?.('发送') || args[0]?.includes?.('speak')) {
      window.speakCalls.push(args)
    }
    originalConsoleLog.apply(console, args)
  }
  
  console.log('✅ speak 监控已启动')
}, 1000)

// 查看所有 speak 调用
// window.speakCalls
```

---

## 📊 诊断清单

使用前请确认：

### 基础配置
- [ ] 魔珐星云 App ID 已配置
- [ ] 魔珐星云 App Secret 已配置
- [ ] 大模型 API Key 已配置
- [ ] 模型名称正确（如 `deepseek-chat`）

### 连接状态
- [ ] 数字人显示"已连接"
- [ ] 状态指示器为绿色
- [ ] 网络信息正常显示

### 功能测试
- [ ] 可以发送消息
- [ ] 聊天框不是一直"思考中"
- [ ] 控制台有流式日志输出
- [ ] 最终显示"播报完成"

### 播报质量
- [ ] 数字人开始说话
- [ ] 字幕正常显示
- [ ] 内容完整（查看总字数）
- [ ] 无遗漏（sentLength === fullLength）

---

## 🔄 完整测试流程

### 1. 准备测试

```bash
# 确保项目运行
npm run dev

# 访问
http://localhost:5173
```

### 2. 打开控制台

按 `F12`，清空控制台

### 3. 检查配置

点击右上角"配置"按钮，确认所有参数已填写

### 4. 发送测试消息

```
你好
```

### 5. 观察输出

应该看到：
1. `开始接收流式响应...`
2. 多条 `Chunk X: ...`
3. 多条 `流式接收: {...}`
4. `首次发送: ...` 或 `后续发送: ...`
5. `流式结束，处理剩余内容: {...}`
6. `✅ 播报完成，总字数: X, 已发送: X`
7. `流式响应结束，总接收: X 字，共 X 个chunk`

### 6. 验证结果

- 聊天框应该显示AI的回复
- "思考中..."应该消失
- 数字人应该说话
- 字幕应该显示

---

## 🎉 预期效果

### 正常流程

```
1. 用户输入 "你好"
   ↓
2. 显示 "思考中..."  ✅
   ↓
3. 控制台开始输出日志  ✅
   ↓
4. 数字人开始说话  ✅
   ↓
5. 字幕同步显示  ✅
   ↓
6. 聊天框显示AI回复  ✅
   ↓
7. "思考中..." 消失  ✅
   ↓
8. 数字人说完所有内容  ✅
```

---

## 📞 获取帮助

如果按照以上步骤仍然无法解决问题，请提供：

1. **控制台完整日志**（从发送消息到结束）
2. **配置信息**（隐藏敏感信息）
3. **浏览器版本**
4. **具体现象描述**

---

**现在请按照上述步骤排查问题，查看控制台输出，我们可以根据日志定位具体问题！** 🔍

