# æ•°å­—äººå®Œæ•´æ’­æŠ¥æµ‹è¯•æŒ‡å—

## âœ… å½“å‰çŠ¶æ€

é¡¹ç›®å·²ç»å®ç°äº†å®Œæ•´æ’­æŠ¥æœºåˆ¶ï¼Œç¡®ä¿æ•°å­—äººä¼šè¯»å‡ºAIç”Ÿæˆçš„æ‰€æœ‰å†…å®¹ã€‚

---

## ğŸ” å®ç°åŸç†

### æ ¸å¿ƒæœºåˆ¶

1. **å‘é€è·Ÿè¸ª**
```typescript
let sentLength = 0  // è®°å½•å·²å‘é€çš„å­—ç¬¦æ•°
```

2. **æµå¼å‘é€**
- é¦–æ¬¡ç§¯æ”’20å­—åå¼€å§‹æ’­æ”¾
- åç»­æ¯10å­—å‘é€ä¸€æ¬¡
- ç»“æŸæ—¶å‘é€æ‰€æœ‰å‰©ä½™å†…å®¹

3. **éªŒè¯ä¿éšœ**
```typescript
// éªŒè¯ï¼šç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½å·²å‘é€
if (sentLength < fullResponse.length) {
  const missed = fullResponse.slice(sentLength)
  console.warn('æ£€æµ‹åˆ°æœªå‘é€çš„å†…å®¹ï¼Œç«‹å³è¡¥å‘:', missed)
  xingyunService!.speak(missed, false, true)
}
```

---

## ğŸ¯ æµ‹è¯•æ­¥éª¤

### æµ‹è¯•1ï¼šé•¿æ–‡æœ¬å®Œæ•´æ’­æŠ¥

**æ“ä½œ**ï¼š
```
å‘é€æ¶ˆæ¯ï¼š"è¯·ç”¨100å­—è¯¦ç»†ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±ï¼ŒåŒ…æ‹¬ä½ çš„èƒ½åŠ›å’Œç‰¹ç‚¹"
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… AIç”Ÿæˆçš„æ‰€æœ‰æ–‡å­—éƒ½èƒ½è¢«è¯»å‡º
- âœ… æœ€åä¸€ä¸ªå­—ä¸ä¼šä¸¢å¤±
- âœ… è¯­éŸ³æ’­æ”¾æµç•…ï¼Œæ— ä¸­æ–­

**éªŒè¯æ–¹æ³•**ï¼š
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
2. è§‚å¯Ÿæ˜¯å¦æœ‰è­¦å‘Šä¿¡æ¯
3. å¯¹æ¯”èŠå¤©é¢æ¿æ˜¾ç¤ºçš„æ–‡å­—å’Œæ•°å­—äººè¯»å‡ºçš„å†…å®¹

---

### æµ‹è¯•2ï¼šçŸ­æ–‡æœ¬æ’­æŠ¥

**æ“ä½œ**ï¼š
```
å‘é€æ¶ˆæ¯ï¼š"ä½ å¥½"
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… å³ä½¿åªæœ‰2ä¸ªå­—ï¼Œä¹Ÿèƒ½å®Œæ•´æ’­æ”¾
- âœ… æ•°å­—äººä¼šè¯´"ä½ å¥½"

**éªŒè¯æ–¹æ³•**ï¼š
1. å¬æ•°å­—äººæ˜¯å¦è¯´å‡º"ä½ å¥½"
2. æ£€æŸ¥æ§åˆ¶å°æ— é”™è¯¯

---

### æµ‹è¯•3ï¼šä¸­ç­‰é•¿åº¦æ–‡æœ¬

**æ“ä½œ**ï¼š
```
å‘é€æ¶ˆæ¯ï¼š"è¯·ç”¨50å­—ä»‹ç»ä¸€ä¸‹æ•°æ®åˆ†æçš„é‡è¦æ€§"
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ‰€æœ‰50å­—éƒ½èƒ½å®Œæ•´æ’­æ”¾
- âœ… æµå¼æ’­æ”¾ï¼Œä½“éªŒæµç•…

**éªŒè¯æ–¹æ³•**ï¼š
1. æ•°ä¸€æ•°AIç”Ÿæˆçš„å­—æ•°
2. å¬æ•°å­—äººæ˜¯å¦å…¨éƒ¨è¯»å®Œ
3. æ£€æŸ¥æ§åˆ¶å°æ— è­¦å‘Š

---

### æµ‹è¯•4ï¼šåŒ…å«æ ‡ç‚¹ç¬¦å·

**æ“ä½œ**ï¼š
```
å‘é€æ¶ˆæ¯ï¼š"è§£é‡Šä¸€ä¸‹ï¼šæ•°æ®åˆ†æã€æ•°æ®æŒ–æ˜ã€æœºå™¨å­¦ä¹ çš„åŒºåˆ«"
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ ‡ç‚¹ç¬¦å·ä¸å½±å“æ’­æŠ¥
- âœ… æ‰€æœ‰æ–‡å­—å†…å®¹å®Œæ•´æ’­æ”¾

---

### æµ‹è¯•5ï¼šå¤šæ¬¡è¿ç»­å¯¹è¯

**æ“ä½œ**ï¼š
```
1. "ä½ å¥½"
2. "è¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±"
3. "ä½ èƒ½åšä»€ä¹ˆ"
4. "è°¢è°¢"
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ¯æ¬¡å¯¹è¯éƒ½èƒ½å®Œæ•´æ’­æŠ¥
- âœ… çŠ¶æ€åˆ‡æ¢æ­£å¸¸
- âœ… æ— å†…å®¹é—æ¼

---

## ğŸ”§ è°ƒè¯•æ–¹æ³•

### æ–¹æ³•1ï¼šæŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹ï¼š

**æ­£å¸¸æƒ…å†µ**ï¼š
```
âœ… æ— è­¦å‘Šä¿¡æ¯
âœ… æ— é”™è¯¯ä¿¡æ¯
```

**å¼‚å¸¸æƒ…å†µ**ï¼š
```
âš ï¸ è­¦å‘Š: "æ£€æµ‹åˆ°æœªå‘é€çš„å†…å®¹ï¼Œç«‹å³è¡¥å‘: xxxx"
```
å¦‚æœçœ‹åˆ°æ­¤è­¦å‘Šï¼Œè¯´æ˜éªŒè¯æœºåˆ¶æ£€æµ‹åˆ°é—æ¼å¹¶è‡ªåŠ¨è¡¥å‘äº†ã€‚

---

### æ–¹æ³•2ï¼šæ£€æŸ¥å‘é€è®°å½•

åœ¨æ§åˆ¶å°æ‰§è¡Œä»¥ä¸‹ä»£ç æ¥ç›‘æ§å‘é€è¿‡ç¨‹ï¼š

```javascript
// åœ¨å‘é€æ¶ˆæ¯å‰åœ¨æ§åˆ¶å°æ‰§è¡Œ
window.speakLog = []
const originalSpeak = window.XmovAvatar.prototype.speak
window.XmovAvatar.prototype.speak = function(text, isStart, isEnd) {
  window.speakLog.push({ text, isStart, isEnd, length: text.length })
  console.log('speakè°ƒç”¨:', { text, isStart, isEnd })
  return originalSpeak.call(this, text, isStart, isEnd)
}
```

ç„¶åå‘é€æ¶ˆæ¯ï¼ŒæŸ¥çœ‹æ‰€æœ‰ speak è°ƒç”¨çš„è®°å½•ã€‚

---

### æ–¹æ³•3ï¼šå¯¹æ¯”æ€»é•¿åº¦

```javascript
// åœ¨æ§åˆ¶å°æŸ¥çœ‹
// 1. æŸ¥çœ‹èŠå¤©é¢æ¿æœ€åä¸€æ¡AIæ¶ˆæ¯çš„å­—æ•°
const lastMessage = document.querySelector('.message-assistant:last-child .message-text')
const displayedText = lastMessage.textContent
console.log('æ˜¾ç¤ºçš„æ–‡å­—:', displayedText)
console.log('å­—æ•°:', displayedText.length)

// 2. å¯¹æ¯”å‘é€çš„æ€»å­—æ•°
const totalSent = window.speakLog.reduce((sum, item) => sum + item.length, 0)
console.log('å‘é€çš„æ€»å­—æ•°:', totalSent)

// 3. å¯¹æ¯”ç»“æœ
console.log('æ˜¯å¦å®Œæ•´:', displayedText.length === totalSent)
```

---

## ğŸ“Š å·¥ä½œæµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥
   â†“
è°ƒç”¨ LLMï¼ˆæµå¼ï¼‰
   â†“
æ¥æ”¶ chunk â†’ è¿‡æ»¤è¡¨æƒ… â†’ ç´¯ç§¯ buffer
   â†“
buffer >= 20å­—ï¼ˆé¦–æ¬¡ï¼‰ â†’ speak(buffer, true, false) â†’ sentLength += buffer.length
   â†“
buffer >= 10å­—ï¼ˆåç»­ï¼‰ â†’ speak(buffer, false, false) â†’ sentLength += buffer.length
   â†“
done = true
   â†“
è®¡ç®—å‰©ä½™: remainingText = fullResponse.slice(sentLength)
   â†“
remainingText æœ‰å†…å®¹ï¼Ÿ
   â”œâ”€ æ˜¯ â†’ speak(remainingText, false, true)
   â””â”€ å¦ â†’ æ£€æŸ¥ isFirst
             â”œâ”€ æ˜¯ â†’ speak(fullResponse, true, true)
             â””â”€ å¦ â†’ speak('', false, true)
   â†“
éªŒè¯: sentLength < fullResponse.lengthï¼Ÿ
   â”œâ”€ æ˜¯ â†’ è¡¥å‘é—æ¼å†…å®¹ï¼ˆå¹¶è­¦å‘Šï¼‰
   â””â”€ å¦ â†’ å®Œæˆ
   â†“
å›åˆ°å¾…æœºçŠ¶æ€
```

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæœ‰æ—¶å€™æ„Ÿè§‰æœ€åå‡ ä¸ªå­—æ²¡è¯»ï¼Ÿ

**å¯èƒ½åŸå› **ï¼š
1. å»¶è¿Ÿé—®é¢˜ï¼šè¯­éŸ³åˆæˆéœ€è¦æ—¶é—´
2. ç½‘ç»œå»¶è¿Ÿï¼šæ•°æ®ä¼ è¾“å»¶è¿Ÿ

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰è­¦å‘Š
- å¦‚æœæœ‰è­¦å‘Šï¼Œè¯´æ˜å·²è‡ªåŠ¨è¡¥å‘
- å¦‚æœæ²¡æœ‰è­¦å‘Šï¼Œå¯èƒ½æ˜¯æ„Ÿè§‰é—®é¢˜ï¼Œå®é™…å·²å‘é€

### Q2: å¦‚ä½•ç¡®è®¤å†…å®¹å®Œæ•´ï¼Ÿ

**éªŒè¯æ–¹æ³•**ï¼š
1. å¯¹æ¯”èŠå¤©é¢æ¿çš„æ–‡å­—å’Œè¯­éŸ³
2. æŸ¥çœ‹æ§åˆ¶å°æ— è­¦å‘Š
3. ä½¿ç”¨è°ƒè¯•æ–¹æ³•æ£€æŸ¥å‘é€è®°å½•

### Q3: çŸ­æ–‡æœ¬ï¼ˆ<20å­—ï¼‰ä¼šæ’­æ”¾å—ï¼Ÿ

**å›ç­”**ï¼šä¼šï¼
- å¦‚æœå†…å®¹ä¸è¶³20å­—ï¼Œåœ¨ `done` æ—¶ä¼šå…¨éƒ¨å‘é€
- ä»£ç ä¸­æœ‰ä¸“é—¨å¤„ç†ï¼š`if (isFirst && fullResponse.trim())`

### Q4: è¡¨æƒ…ç¬¦å·ä¼šå½±å“å—ï¼Ÿ

**å›ç­”**ï¼šä¸ä¼šï¼
- è¡¨æƒ…ç¬¦å·ä¼šè¢«è‡ªåŠ¨è¿‡æ»¤
- AI ä¹Ÿè¢«è¦æ±‚ä¸ç”Ÿæˆè¡¨æƒ…
- åŒé‡ä¿éšœç¡®ä¿çº¯æ–‡å­—

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### æ­£å¸¸æ’­æŠ¥æŒ‡æ ‡

| æŒ‡æ ‡ | æ ‡å‡† |
|------|------|
| å®Œæ•´ç‡ | 100% |
| é¦–å­—å»¶è¿Ÿ | < 2ç§’ |
| æµç•…åº¦ | æ— å¡é¡¿ |
| é”™è¯¯ç‡ | 0% |

### æ£€æŸ¥æ–¹æ³•

```javascript
// è®°å½•å¼€å§‹æ—¶é—´
const startTime = Date.now()

// ç›‘å¬ speak è°ƒç”¨
let firstSpeakTime = null
window.XmovAvatar.prototype.speak = function(text, isStart, isEnd) {
  if (isStart && !firstSpeakTime) {
    firstSpeakTime = Date.now()
    console.log('é¦–å­—å»¶è¿Ÿ:', firstSpeakTime - startTime, 'ms')
  }
  // ... è°ƒç”¨åŸå§‹æ–¹æ³•
}
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æé—®æŠ€å·§

**æ¨è**ï¼š
```
âœ… "è¯·ç”¨50å­—ä»‹ç»æ•°æ®åˆ†æ"  // æ˜ç¡®å­—æ•°
âœ… "è¯¦ç»†è¯´æ˜BIçš„ä½œç”¨"      // æ¸…æ™°éœ€æ±‚
```

**ä¸æ¨è**ï¼š
```
âŒ "è®²è®²ğŸ˜Š"                // åŒ…å«è¡¨æƒ…
âŒ "è¯´ç‚¹ä»€ä¹ˆ"              // å¤ªæ¨¡ç³Š
```

### 2. è§‚å¯Ÿæ–¹å¼

- âœ… å¬å®Œæ•´æ®µå†…å®¹å†åˆ¤æ–­
- âœ… æŸ¥çœ‹æ§åˆ¶å°ç¡®è®¤
- âŒ ä¸è¦åœ¨ä¸­é€”æ‰“æ–­

### 3. é—®é¢˜åé¦ˆ

å¦‚æœå‘ç°é—®é¢˜ï¼Œè®°å½•ï¼š
1. è¾“å…¥çš„é—®é¢˜
2. AI ç”Ÿæˆçš„æ–‡å­—
3. æ§åˆ¶å°çš„è­¦å‘Šä¿¡æ¯
4. æ˜¯å¦æœ‰è‡ªåŠ¨è¡¥å‘

---

## ğŸ” é«˜çº§è°ƒè¯•

### å®Œæ•´ç›‘æ§è„šæœ¬

```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œæ­¤è„šæœ¬ï¼Œå®Œæ•´ç›‘æ§æ’­æŠ¥è¿‡ç¨‹
(function() {
  let speakCalls = []
  let fullResponse = ''
  
  // è®°å½• speak è°ƒç”¨
  const originalSpeak = window.XmovAvatar.prototype.speak
  window.XmovAvatar.prototype.speak = function(text, isStart, isEnd) {
    speakCalls.push({
      text: text,
      length: text.length,
      isStart: isStart,
      isEnd: isEnd,
      timestamp: Date.now()
    })
    
    console.log(`[Speak] ${isStart ? 'å¼€å§‹' : ''}${isEnd ? 'ç»“æŸ' : ''}:`, text)
    return originalSpeak.call(this, text, isStart, isEnd)
  }
  
  // ç›‘å¬æ¶ˆæ¯
  window.addEventListener('message', (e) => {
    if (e.data.type === 'ai-response') {
      fullResponse = e.data.content
    }
  })
  
  // éªŒè¯å‡½æ•°
  window.verifySpeech = function() {
    const totalSent = speakCalls.reduce((sum, call) => sum + call.length, 0)
    const totalExpected = fullResponse.length
    
    console.log('=== æ’­æŠ¥éªŒè¯ ===')
    console.log('AIç”Ÿæˆå­—æ•°:', totalExpected)
    console.log('å®é™…å‘é€å­—æ•°:', totalSent)
    console.log('å‘é€æ¬¡æ•°:', speakCalls.length)
    console.log('æ˜¯å¦å®Œæ•´:', totalSent === totalExpected ? 'âœ…' : 'âŒ')
    
    if (totalSent !== totalExpected) {
      console.warn('å·®å¼‚:', totalExpected - totalSent, 'å­—')
    }
    
    return speakCalls
  }
  
  console.log('ç›‘æ§è„šæœ¬å·²å¯åŠ¨ï¼Œå‘é€æ¶ˆæ¯åæ‰§è¡Œ verifySpeech() æŸ¥çœ‹ç»“æœ')
})()
```

---

## âœ… éªŒè¯æ¸…å•

åœ¨ä½¿ç”¨å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] é¡µé¢æ­£å¸¸åŠ è½½ï¼Œæ— æ§åˆ¶å°é”™è¯¯
- [ ] æ•°å­—äººå·²è¿æ¥ï¼ˆçŠ¶æ€æ˜¾ç¤º"å·²è¿æ¥"ï¼‰
- [ ] å¤§æ¨¡å‹ API é…ç½®æ­£ç¡®
- [ ] å‘é€æ¶ˆæ¯åæ•°å­—äººæœ‰å“åº”
- [ ] å­—å¹•æ­£å¸¸æ˜¾ç¤º
- [ ] è¯­éŸ³æ’­æ”¾æ­£å¸¸

å®Œæ•´æ’­æŠ¥æµ‹è¯•ï¼š

- [ ] é•¿æ–‡æœ¬ï¼ˆ>100å­—ï¼‰å®Œæ•´æ’­æ”¾
- [ ] çŸ­æ–‡æœ¬ï¼ˆ<20å­—ï¼‰å®Œæ•´æ’­æ”¾
- [ ] ä¸­ç­‰æ–‡æœ¬ï¼ˆ20-100å­—ï¼‰å®Œæ•´æ’­æ”¾
- [ ] å¤šæ¬¡å¯¹è¯éƒ½èƒ½å®Œæ•´æ’­æ”¾
- [ ] æ§åˆ¶å°æ— è­¦å‘Šä¿¡æ¯
- [ ] æœ€åä¸€ä¸ªå­—ä¸ä¸¢å¤±

---

## ğŸ‰ æ€»ç»“

### å®ç°ç‰¹ç‚¹

1. âœ… **å®Œæ•´æ€§ä¿éšœ**
   - è·Ÿè¸ªå·²å‘é€é•¿åº¦
   - è®¡ç®—å‰©ä½™å†…å®¹
   - éªŒè¯å¹¶è‡ªåŠ¨è¡¥å‘

2. âœ… **æµç•…ä½“éªŒ**
   - é¦–æ¬¡ç§¯æ”’20å­—
   - åç»­æ¯10å­—å‘é€
   - å‡å°‘é¦–å­—å»¶è¿Ÿ

3. âœ… **è‡ªåŠ¨ä¿®å¤**
   - æ£€æµ‹é—æ¼å†…å®¹
   - è‡ªåŠ¨è¡¥å‘
   - æ§åˆ¶å°è­¦å‘Š

4. âœ… **æ˜“äºè°ƒè¯•**
   - æ¸…æ™°çš„æ—¥å¿—
   - éªŒè¯æœºåˆ¶
   - ç›‘æ§å·¥å…·

---

**ç°åœ¨æ•°å­—äººå·²ç»èƒ½å¤Ÿå®Œæ•´è¯»å‡ºAIç”Ÿæˆçš„æ‰€æœ‰å†…å®¹ï¼** âœ¨ğŸ¤

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—æˆ–ä½¿ç”¨è°ƒè¯•å·¥å…·è¿›è¡Œæ’æŸ¥ã€‚

